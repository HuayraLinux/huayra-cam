<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="jquery1.3.js"></script>
</head>
<body>

    <div id="divflash"></div>
    <div class="btn-salir"></div>
    <div class="btn-foto"></div>

    <video id="huayracam" width="500" height="500" autoplay></video>
    <canvas id="canvas" width="500" height="500" style="display:none;"></canvas>

    <script>

		// modifico la resoluci√≥n tomando la real de la pantalla
		var pantalla = document.querySelector('#huayracam');
		pantalla.setAttribute("width", screen.width);
		pantalla.setAttribute("height", screen.height + 20);

		var elcanvas = document.querySelector('#canvas');
		elcanvas.setAttribute("width", screen.width);
		elcanvas.setAttribute("height", screen.height +40);

        $("#divflash").hide(); 
		
		// Capturo el directorio IMAGENES del usuario
		var exec = require('child_process').execSync;
		var cmd = 'xdg-user-dir PICTURES';


	var path = exec(cmd).toString().slice(0,-1),
            gui = require('nw.gui'),
            win = gui.Window.get();
	
        document.querySelector('.btn-salir').addEventListener('click', function(){
            win.close();
        });
        document.querySelector('.btn-foto').addEventListener('click', function(){
            snapshot();
        });
        
	
        function sacafoto(img){

            var fs = require('fs'),
                sys = require('util');
            
            var data = img.replace(/^data:image\/\w+;base64,/, "");
            var buf = new Buffer(data, 'base64');
            fs.writeFile(path + '/' +new Date().getTime()+ '.png', buf);

            $("#divflash").show(); 
            $("#divflash").fadeOut(300); 

        }

        var errorCallback = function(e) {
            console.log('Error!', e);
        };

        var video = document.querySelector('video');
        var canvas = document.querySelector('canvas');
        var ctx = canvas.getContext('2d');
        var localMediaStream = null;

        function snapshot() {
            if (localMediaStream) {
              ctx.drawImage(video, 0, 0, screen.width, screen.height + 40);          
              sacafoto(canvas.toDataURL('image/png'));
            }
        }

        video.addEventListener('click', snapshot, false);
      
          navigator.webkitGetUserMedia({video: true}, function(stream) {
            video.src = window.URL.createObjectURL(stream);
            localMediaStream = stream;
        }, errorCallback);

		// capturar teclado
		$(document).ready(function(){
		 
			  $(document).keypress(function(e) {
				    //32 es el codigo de espacio
				    if(e.which == 32) {
				        snapshot();}
			  });         
			  $(document).keyup(function(e) {
				    //27 es el codigo de ESC
				    if(e.keyCode == 27) {
				         win.close();}
			  });  
		});

      </script>

  </body>
  </html>
