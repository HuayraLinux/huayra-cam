<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="style.css" type="text/css"/>
	</head>
	<body>
		<div id="divflash"></div>
		<div id="divNoCam">
			<span class='noCam'>No se detect칩 ninguna c치mara.<br />
			Presione ESC para salir.</span>
		</div>
		<div class="btn-salir"></div>
		<div class="btn-foto"></div>

		<video id='huayracam' width="1360" height="768" autoplay></video>
		<canvas width="1024" height="768" style="display:none;"></canvas>
		<script type="text/javascript">
			/* por c칩mo es electron jquery se carga como m칩dulo */
			const $ = require('/usr/share/javascript/jquery/jquery.min.js');

			// Capturo el directorio IMAGENES del usuario
			const exec = require('child_process').execSync;
			const cmd  = 'xdg-user-dir PICTURES';
			const path = exec(cmd).toString().slice(0,-1);
			const win  = require('electron').remote.getCurrentWindow();

			function sacafoto(img) {
				const fs  = require('fs');

				var data = img.replace(/^data:image\/\w+;base64,/, '');
				var buf = new Buffer(data, 'base64');
				fs.writeFile(path + '/' +new Date().getTime()+ '.png', buf);

				$('#divflash').show();
				$('#divflash').fadeOut(300);
			}

			let localMediaStream = null;

			function snapshot() {
				if (localMediaStream) {
					ctx.drawImage(video, 0, 0, 1024, 768);
					sacafoto(canvas.toDataURL('image/png'));
				}
			}

			$('#divflash').hide();
			$('#divNoCam').hide();
			$('.btn-salir').click(() => win.close());
			$('.btn-foto').click(snapshot);
			$(document).keypress((e) => {
				if(e.which == 32) snapshot(); /* Barra espaciadora */
			});
			$(document).keyup((e) => {
				if(e.keyCode == 27) win.close(); /* Escape */
			});

			const video = document.querySelector('video');
			const canvas = document.querySelector('canvas');
			const ctx = canvas.getContext('2d');

			/* Cargar el video*/
			navigator.webkitGetUserMedia({video: true}, function(stream) {
				video.srcObject = stream;
				localMediaStream = stream;
			}, () => $('#divNoCam').show());

			video.addEventListener('click', snapshot, false);
		</script>
	</body>
</html>
